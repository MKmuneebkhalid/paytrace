<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Card on File</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #131a29;
      --bg-card: #1a2235;
      --border-color: #2a3650;
      --text-primary: #f0f4fc;
      --text-secondary: #8b9dc3;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --error: #ef4444;
      --radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
    }

    .container {
      width: 100%;
      max-width: 480px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .header svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      color: var(--accent);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    input::placeholder {
      color: var(--text-secondary);
      opacity: 0.6;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 100px;
      gap: 16px;
    }

    .submit-btn {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      margin-top: 8px;
    }

    .submit-btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .submit-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .message {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .message.success {
      display: block;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .message.error {
      display: block;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .security-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 12px;
    }

    .security-badge svg {
      width: 14px;
      height: 14px;
      color: var(--success);
    }

    .card-input-wrapper {
      position: relative;
    }

    .card-input-wrapper input {
      padding-right: 100px;
    }

    .card-type-badge {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .card-type-badge.visa { color: #1a1f71; }
    .card-type-badge.mastercard { color: #eb001b; }
    .card-type-badge.amex { color: #006fcf; }
    .card-type-badge.discover { color: #ff6000; }

    .card-type-badge svg {
      width: 32px;
      height: 20px;
    }

    .validation-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
    }

    .validation-icon.valid {
      color: var(--success);
    }

    .validation-icon.invalid {
      color: var(--error);
    }

    input.valid {
      border-color: var(--success);
    }

    input.invalid {
      border-color: var(--error);
    }

    .field-hint {
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-secondary);
    }

    .field-hint.error {
      color: var(--error);
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
          <line x1="1" y1="10" x2="23" y2="10"/>
        </svg>
        <h1>Card on File</h1>
        <p>Enter your card details to save for future use</p>
      </div>

      <form id="cardForm">
        <div class="form-group">
          <label>Customer ID / Reference</label>
          <input type="text" id="customerId" placeholder="e.g., CLIENT-12345" required>
        </div>

        <div class="form-group">
          <label>Cardholder Name</label>
          <input type="text" id="cardholderName" placeholder="Name as it appears on card" required>
        </div>

        <div class="form-group">
          <label>Card Number</label>
          <div class="card-input-wrapper">
            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required autocomplete="cc-number">
            <div id="cardTypeBadge" class="card-type-badge"></div>
          </div>
          <div id="cardHint" class="field-hint"></div>
        </div>

        <div class="row-3">
          <div class="form-group">
            <label>Exp Month</label>
            <select id="expMonth" required>
              <option value="">MM</option>
              <option value="01">01</option>
              <option value="02">02</option>
              <option value="03">03</option>
              <option value="04">04</option>
              <option value="05">05</option>
              <option value="06">06</option>
              <option value="07">07</option>
              <option value="08">08</option>
              <option value="09">09</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
            </select>
          </div>
          <div class="form-group">
            <label>Exp Year</label>
            <select id="expYear" required>
              <option value="">YYYY</option>
            </select>
          </div>
          <div class="form-group">
            <label>CVV</label>
            <input type="text" id="cvv" placeholder="123" maxlength="4" required>
            <div id="cvvHint" class="field-hint"></div>
          </div>
        </div>

        <div class="form-group">
          <label>Billing Address</label>
          <input type="text" id="streetAddress" placeholder="Street address" required>
        </div>

        <div class="row">
          <div class="form-group">
            <label>City</label>
            <input type="text" id="city" placeholder="City" required>
          </div>
          <div class="form-group">
            <label>State</label>
            <input type="text" id="state" placeholder="State" required maxlength="2">
          </div>
        </div>

        <div class="form-group">
          <label>ZIP Code</label>
          <input type="text" id="zip" placeholder="ZIP" required maxlength="10">
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          <span id="btnText">Save Card</span>
        </button>
      </form>

      <div id="message" class="message"></div>

      <div class="security-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        <span>Secure connection · Card stored in PayTrace vault</span>
      </div>
    </div>
  </div>

  <script>
    // Card type detection patterns
    const cardPatterns = {
      visa: /^4/,
      mastercard: /^5[1-5]|^2[2-7]/,
      amex: /^3[47]/,
      discover: /^6(?:011|5)/
    };

    const cardInfo = {
      visa: { name: 'Visa', cvvLength: 3, color: '#1a1f71' },
      mastercard: { name: 'Mastercard', cvvLength: 3, color: '#eb001b' },
      amex: { name: 'Amex', cvvLength: 4, color: '#006fcf' },
      discover: { name: 'Discover', cvvLength: 3, color: '#ff6000' }
    };

    // Luhn algorithm to validate card number
    function luhnCheck(cardNumber) {
      if (!cardNumber || cardNumber.length < 13) return false;
      
      let sum = 0;
      let isEven = false;
      
      for (let i = cardNumber.length - 1; i >= 0; i--) {
        let digit = parseInt(cardNumber[i], 10);
        
        if (isEven) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }
        
        sum += digit;
        isEven = !isEven;
      }
      
      return sum % 10 === 0;
    }

    // Detect card type from number
    function detectCardType(cardNumber) {
      const cleanNumber = cardNumber.replace(/\s/g, '');
      for (const [type, pattern] of Object.entries(cardPatterns)) {
        if (pattern.test(cleanNumber)) return type;
      }
      return null;
    }

    // Get card SVG icon
    function getCardIcon(type) {
      const icons = {
        visa: `<svg viewBox="0 0 48 32" fill="currentColor"><path d="M18.5 21.5h-3l1.9-12h3l-1.9 12zm13.1-11.7c-.6-.2-1.5-.5-2.7-.5-3 0-5.1 1.6-5.1 3.9 0 1.7 1.5 2.6 2.6 3.2 1.2.6 1.6.9 1.6 1.4 0 .8-.9 1.1-1.8 1.1-1.2 0-1.9-.2-2.9-.6l-.4-.2-.4 2.7c.7.3 2.1.6 3.5.6 3.2 0 5.3-1.6 5.3-4 0-1.3-.8-2.4-2.5-3.2-1-.5-1.7-.9-1.7-1.4 0-.5.5-1 1.7-1 1 0 1.7.2 2.3.5l.3.1.4-2.6zm7.9-.3h-2.3c-.7 0-1.3.2-1.6 1l-4.4 10.5h3.1l.6-1.7h3.8l.4 1.7h2.7l-2.3-11.5zm-3.6 7.4c.2-.7 1.1-3.3 1.1-3.3s.2-.6.4-1l.2.9.6 3.3h-2.3zM15 9.5l-2.8 8.2-.3-1.5c-.5-1.8-2.2-3.7-4-4.7l2.6 9.9h3.2l4.8-11.9H15z"/><path fill="#F9A51A" d="M9.6 9.5H4.9l-.1.3c3.8 1 6.3 3.3 7.3 6.1l-1-5.3c-.2-.8-.8-1.1-1.5-1.1z"/></svg>`,
        mastercard: `<svg viewBox="0 0 48 32" fill="none"><circle cx="18" cy="16" r="10" fill="#EB001B"/><circle cx="30" cy="16" r="10" fill="#F79E1B"/><path d="M24 8.5a10 10 0 0 0 0 15 10 10 0 0 0 0-15z" fill="#FF5F00"/></svg>`,
        amex: `<svg viewBox="0 0 48 32" fill="currentColor"><path d="M0 4h48v24H0V4zm5 6l-3 8h3.5l.5-1.2h2l.5 1.2h4V11l3 7h2.5l3-7v7h2V10h-4l-2.5 6-2.5-6H5zm1.5 2l-.8 2h1.6l-.8-2zm18.5-2v8h2v-3h3v3h2v-8h-2v3h-3v-3h-2zm9 0v8h7v-2h-5v-1h5v-2h-5v-1h5v-2h-7z"/></svg>`,
        discover: `<svg viewBox="0 0 48 32" fill="currentColor"><rect x="0" y="4" width="48" height="24" rx="4" fill="#FF6000"/><ellipse cx="24" cy="16" rx="8" ry="6" fill="#fff"/><text x="24" y="26" text-anchor="middle" font-size="6" fill="#fff" font-weight="bold">DISCOVER</text></svg>`
      };
      return icons[type] || '';
    }

    let currentCardType = null;

    // Populate year dropdown
    const yearSelect = document.getElementById('expYear');
    const currentYear = new Date().getFullYear();
    for (let i = 0; i < 12; i++) {
      const year = currentYear + i;
      const option = document.createElement('option');
      option.value = year.toString();
      option.textContent = year;
      yearSelect.appendChild(option);
    }

    // Format and validate card number
    document.getElementById('cardNumber').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
      
      // Detect card type
      currentCardType = detectCardType(value);
      const badge = document.getElementById('cardTypeBadge');
      const hint = document.getElementById('cardHint');
      const cvvInput = document.getElementById('cvv');
      const cvvHint = document.getElementById('cvvHint');
      
      if (currentCardType) {
        const info = cardInfo[currentCardType];
        badge.innerHTML = `${getCardIcon(currentCardType)} ${info.name}`;
        badge.style.color = info.color;
        cvvInput.maxLength = info.cvvLength;
        cvvInput.placeholder = info.cvvLength === 4 ? '1234' : '123';
        cvvHint.textContent = `${info.cvvLength} digits on ${currentCardType === 'amex' ? 'front' : 'back'} of card`;
      } else {
        badge.innerHTML = '';
        cvvInput.maxLength = 4;
        cvvInput.placeholder = '123';
        cvvHint.textContent = '';
      }
      
      // Format with spaces (Amex: 4-6-5, others: 4-4-4-4)
      let formatted;
      if (currentCardType === 'amex') {
        formatted = value.replace(/(\d{4})(\d{0,6})(\d{0,5})/, (m, a, b, c) => 
          [a, b, c].filter(Boolean).join(' ')
        );
        e.target.maxLength = 17;
      } else {
        formatted = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.maxLength = 19;
      }
      e.target.value = formatted;
      
      // Validate with Luhn
      if (value.length >= 13) {
        const isValid = luhnCheck(value);
        e.target.classList.toggle('valid', isValid);
        e.target.classList.toggle('invalid', !isValid);
        hint.textContent = isValid ? '✓ Valid card number' : '✗ Invalid card number';
        hint.className = `field-hint ${isValid ? '' : 'error'}`;
      } else {
        e.target.classList.remove('valid', 'invalid');
        hint.textContent = '';
      }
    });

    // CVV validation
    document.getElementById('cvv').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '');
      const expectedLength = currentCardType && cardInfo[currentCardType] ? cardInfo[currentCardType].cvvLength : 3;
      const isValid = e.target.value.length === expectedLength;
      
      if (e.target.value.length > 0) {
        e.target.classList.toggle('valid', isValid);
        e.target.classList.toggle('invalid', !isValid && e.target.value.length >= expectedLength);
      } else {
        e.target.classList.remove('valid', 'invalid');
      }
    });

    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
    }

    function setLoading(loading) {
      const btn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      
      btn.disabled = loading;
      btnText.innerHTML = loading 
        ? '<span class="loading"><span class="spinner"></span> Saving...</span>'
        : 'Save Card';
    }

    document.getElementById('cardForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const customerId = document.getElementById('customerId').value.trim();
      const cardholderName = document.getElementById('cardholderName').value.trim();
      const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
      const expMonth = document.getElementById('expMonth').value;
      const expYear = document.getElementById('expYear').value;
      const cvv = document.getElementById('cvv').value.trim();
      const streetAddress = document.getElementById('streetAddress').value.trim();
      const city = document.getElementById('city').value.trim();
      const state = document.getElementById('state').value.trim().toUpperCase();
      const zip = document.getElementById('zip').value.trim();

      if (!customerId || !cardNumber || !expMonth || !expYear) {
        showMessage('Please fill in all required fields', 'error');
        return;
      }

      if (cardNumber.length < 13 || !luhnCheck(cardNumber)) {
        showMessage('Please enter a valid card number', 'error');
        return;
      }

      const expectedCvvLength = currentCardType && cardInfo[currentCardType] ? cardInfo[currentCardType].cvvLength : 3;
      if (cvv.length !== expectedCvvLength) {
        showMessage(`CVV must be ${expectedCvvLength} digits for ${currentCardType ? cardInfo[currentCardType].name : 'this card'}`, 'error');
        return;
      }

      setLoading(true);
      document.getElementById('message').className = 'message';

      try {
        const response = await fetch('/api/customers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customerId,
            cardNumber,
            expirationMonth: expMonth,
            expirationYear: expYear,
            cvv,
            billingAddress: {
              name: cardholderName,
              street_address: streetAddress,
              city,
              state,
              zip
            }
          })
        });

        const result = await response.json();

        if (result.success) {
          showMessage(`Card saved successfully! Masked card: ${result.maskedCardNumber}`, 'success');
          document.getElementById('cardForm').reset();
        } else {
          throw new Error(result.error || 'Failed to save card');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage(error.message || 'An error occurred. Please try again.', 'error');
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
